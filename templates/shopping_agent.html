{% extends "base.html" %}

{% block title %}AI Shopping Assistant{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .product-card {
        transition: transform 0.2s;
    }
    
    .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* Product Actions - Match catalog exactly */
    .product-actions {
        display: flex;
        gap: 8px;
        margin-top: auto;
    }
    
    /* Ensure chat product styles match catalog */
    .products-container .product-actions {
        display: flex;
        gap: 8px;
        margin-top: auto;
    }
    
    .products-container .cart-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }
    
    .products-container .quantity-btn {
        width: 32px;
        height: 32px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 16px;
        font-weight: bold;
        color: #666;
        padding: 0;
        line-height: 1;
    }
    
    .products-container .quantity-btn:hover {
        background: #f5f5f5;
        border-color: #007bff;
        color: #007bff;
    }
    
    .products-container .quantity-display {
        min-width: 40px;
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        color: #333;
    }
    
    .products-container .remove-btn {
        width: 32px;
        height: 32px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 16px;
        padding: 0;
        line-height: 1;
    }
    
    .products-container .remove-btn:hover {
        background: #c82333;
    }
    
    .products-container .quick-view-btn {
        width: 40px;
        height: 40px;
        background: #f8f9fa;
        border: 1px solid #e5e5e5;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        font-size: 16px;
        padding: 0;
        line-height: 1;
        color: #6c757d;
    }
    
    .products-container .quick-view-btn:hover {
        background: #e9ecef;
        border-color: #007bff;
        color: #007bff;
    }

    /* Add to Cart Button - Match catalog exactly */
    .products-container .add-to-cart-btn {
        flex: 1;
        padding: 10px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .products-container .add-to-cart-btn:hover {
        background: #218838;
    }
    
    .product-card .add-to-cart-btn,
    #productModal .add-to-cart-btn {
        flex: 1;
        padding: 10px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .product-card .add-to-cart-btn:hover,
    #productModal .add-to-cart-btn:hover {
        background: #218838;
    }

    .add-to-cart-btn .btn-text {
        display: inline;
    }

    /* Max width for list view */
    .products-list .add-to-cart-btn {
        max-width: 150px;
    }

    /* Cart Controls - Match catalog exactly */
    .cart-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }

    .quantity-btn {
        width: 32px;
        height: 32px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 12px;
        color: #666;
    }

    .quantity-btn:hover {
        background: #f5f5f5;
        border-color: #007bff;
        color: #007bff;
    }

    .quantity-display {
        min-width: 40px;
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        color: #333;
    }

    .remove-btn {
        width: 32px;
        height: 32px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 14px;
    }

    .remove-btn:hover {
        background: #c82333;
    }

    /* Quick View Button - Match catalog exactly */
    .quick-view-btn {
        width: 40px;
        height: 40px;
        background: #f8f9fa;
        border: 1px solid #e5e5e5;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .quick-view-btn:hover {
        background: #e9ecef;
        border-color: #007bff;
        color: #007bff;
    }
    
    /* Font Awesome Icons Visibility */
    .products-container .fas,
    .product-card .fas,
    #productModal .fas {
        display: inline-block !important;
        font-family: "Font Awesome 6 Free" !important;
        font-weight: 900 !important;
        font-style: normal !important;
        font-variant: normal !important;
        text-rendering: auto !important;
        line-height: 1 !important;
    }
    
    .products-container .fa-minus::before,
    .product-card .fa-minus::before,
    #productModal .fa-minus::before {
        content: "\f068" !important;
    }
    
    .products-container .fa-plus::before,
    .product-card .fa-plus::before,
    #productModal .fa-plus::before {
        content: "\f067" !important;
    }
    
    .products-container .fa-trash::before,
    .product-card .fa-trash::before,
    #productModal .fa-trash::before {
        content: "\f2ed" !important;
    }
    
    .products-container .fa-shopping-cart::before,
    .product-card .fa-shopping-cart::before,
    #productModal .fa-shopping-cart::before {
        content: "\f07a" !important;
    }
    
    .products-container .fa-eye::before,
    .product-card .fa-eye::before,
    #productModal .fa-eye::before {
        content: "\f06e" !important;
    }
    
    /* Product Modal Styles */
    #productModal .modal-dialog {
        max-width: 1200px;
    }
    
    #productModal .modal-content {
        border: none;
        border-radius: 12px;
        overflow: hidden;
    }
    
    #productModal .modal-header {
        position: absolute;
        right: 0;
        top: 0;
        z-index: 10;
        background: transparent;
    }
    
    #productModal .btn-close {
        background-color: white;
        opacity: 0.8;
        border-radius: 50%;
        padding: 0.5rem;
        margin: 0.5rem;
    }
    
    #productModal .btn-close:hover {
        opacity: 1;
    }
    
    .thumbnail {
        transition: border-color 0.3s;
    }
    
    .thumbnail:hover {
        border-color: #0056b3 !important;
    }
    
    .product-details h2 {
        font-size: 1.75rem;
        font-weight: 600;
    }
    
    .product-details h3 {
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    /* Modal specific overrides - maintain consistency */
    #productModal .add-to-cart-btn.btn-lg {
        padding: 12px 24px;
        font-size: 16px;
    }
    
    #productModal .cart-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    #productModal .quantity-btn {
        width: 40px;
        height: 40px;
    }
    
    #productModal .quantity-display {
        min-width: 50px;
        font-size: 18px;
    }
    
    #productModal .remove-btn {
        width: auto;
        padding: 8px 16px;
        font-size: 14px;
    }
    
    /* Responsive styles to match catalog */
    @media (max-width: 768px) {
        /* Hide add to cart button text on mobile */
        .add-to-cart-btn .btn-text {
            display: none;
        }

        .add-to-cart-btn {
            min-width: 40px;
            padding: 8px;
        }
    }
    
    @media (max-width: 991px) {
        #productModal .modal-dialog {
            max-width: 100%;
            margin: 0.5rem;
        }
        
        .main-product-image {
            height: 300px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- Chat Container -->
        <div class="col-md-8 h-100 d-flex flex-column">
            <div class="chat-header bg-primary text-white p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">
                            <i class="bi bi-robot"></i> Shopping Assistant
                        </h4>
                        <small class="opacity-75">Ask me anything about our products!</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm" onclick="clearChat()">
                            <i class="bi bi-trash"></i> Clear Chat
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="exportChat()">
                            <i class="bi bi-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages flex-grow-1 p-3" id="chatMessages">
                <div class="welcome-message text-center py-5">
                    <div class="mb-3">
                        <i class="bi bi-robot" style="font-size: 3rem; color: #007bff;"></i>
                    </div>
                    <h5>Welcome! I'm your AI Shopping Assistant</h5>
                    <p class="text-muted">I can help you find products, answer questions, and provide recommendations.</p>
                    <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
                        <button class="btn btn-outline-primary btn-sm suggestion-btn" onclick="sendMessage('I\'m looking for running shoes')">
                            Find running shoes
                        </button>
                        <button class="btn btn-outline-primary btn-sm suggestion-btn" onclick="sendMessage('Show me products under $50')">
                            Products under $50
                        </button>
                        <button class="btn btn-outline-primary btn-sm suggestion-btn" onclick="sendMessage('What\'s popular right now?')">
                            What's popular?
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="chat-input border-top p-3">
                <div class="row g-2">
                    <div class="col">
                        <div class="input-group">
                            <input type="text" class="form-control" id="messageInput" 
                                   placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleImageUpload()">
                                <i class="bi bi-image"></i>
                            </button>
                            <button class="btn btn-primary" type="button" onclick="sendCurrentMessage()">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                        
                        <!-- Image Upload Area (Hidden by default) -->
                        <div class="image-upload-container mt-2" id="imageUploadContainer" style="display: none;">
                            <div class="image-upload-area border border-2 border-dashed rounded p-3 text-center" 
                                 onclick="document.getElementById('imageInput').click()">
                                <div id="imageUploadText">
                                    <i class="bi bi-cloud-upload fs-3 text-muted"></i>
                                    <p class="mb-0 text-muted">Click to upload an image or drag and drop</p>
                                    <small class="text-muted">Supported formats: JPG, PNG, GIF (max 10MB)</small>
                                </div>
                                <div id="imagePreviewContainer" style="display: none;">
                                    <img id="imagePreview" class="img-thumbnail" style="max-height: 150px;">
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-danger" onclick="clearImage()">
                                            <i class="bi bi-x"></i> Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                        </div>
                    </div>
                </div>
                
                <!-- Suggestions -->
                <div class="suggestions mt-2" id="suggestions" style="display: none;">
                    <small class="text-muted">Quick suggestions:</small>
                    <div class="d-flex flex-wrap gap-1 mt-1" id="suggestionButtons">
                        <!-- Suggestions will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4 bg-light border-start h-100">
            <div class="p-3">
                <h6>
                    <i class="bi bi-clock-history"></i> Recent Products
                </h6>
                <div id="recentProducts" class="mt-3">
                    <p class="text-muted text-center">Products you've viewed will appear here</p>
                </div>
            </div>
            
            <hr>
            
            <div class="p-3">
                <h6>
                    <i class="bi bi-gear"></i> Quick Actions
                </h6>
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-outline-primary btn-sm" onclick="sendMessage('Show me your best deals')">
                        <i class="bi bi-tag"></i> Best Deals
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="sendMessage('What are the newest products?')">
                        <i class="bi bi-star"></i> New Arrivals
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="sendMessage('Help me find a gift')">
                        <i class="bi bi-gift"></i> Gift Ideas
                    </button>
                    <a href="/agent/settings" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-gear"></i> Settings
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0">Thinking...</p>
            </div>
        </div>
    </div>
</div>

<!-- Product Detail Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="productModalBody">
                <div class="container-fluid">
                    <div class="row">
                        <!-- Image Gallery -->
                        <div class="col-lg-6 p-4">
                            <div class="product-image-gallery">
                                <div class="main-product-image mb-3" style="height: 400px; overflow: hidden; border-radius: 8px;">
                                    <img id="mainProductImage" src="" alt="" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div class="product-thumbnails d-flex gap-2 flex-wrap" id="productThumbnails">
                                    <!-- Thumbnails will be inserted here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Product Info -->
                        <div class="col-lg-6 p-4">
                            <div class="product-details">
                                <h2 id="modalProductTitle" class="mb-3"></h2>
                                <p class="text-muted mb-3" id="modalProductVendor"></p>
                                
                                <div class="price-section mb-4">
                                    <h3 class="text-primary" id="modalProductPrice"></h3>
                                </div>
                                
                                <!-- Options -->
                                <div id="modalProductOptions" class="mb-4">
                                    <!-- Options will be inserted here -->
                                </div>
                                
                                <!-- Cart Actions -->
                                <div class="cart-actions mb-4" id="modalCartActions">
                                    <!-- Cart buttons will be inserted here -->
                                </div>
                                
                                <!-- Description -->
                                <div class="product-description">
                                    <h5>Description</h5>
                                    <div id="modalProductDescription"></div>
                                </div>
                                
                                <!-- Additional Details -->
                                <div class="additional-details mt-4">
                                    <h6>Product Details</h6>
                                    <ul class="list-unstyled" id="modalProductDetails">
                                        <!-- Details will be inserted here -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
const sessionId = '{{ session_id }}';
let currentImageData = null;
let messageCount = 0;

// Initialize
$(document).ready(function() {
    loadConversationHistory();
    setupDragAndDrop();
    
    // Override updateCartUI to also update chat products
    setTimeout(() => {
        if (typeof window.updateCartUI === 'function') {
            const originalUpdateCartUI = window.updateCartUI;
            window.updateCartUI = function() {
                originalUpdateCartUI.apply(this, arguments);
                // Update chat products with our custom styling
                setTimeout(() => {
                    updateChatProductCards();
                }, 50);
            };
        }
    }, 100);
    
    // Simple approach - fix icons after any chat updates
    const originalAppend = $.fn.append;
    $.fn.append = function() {
        const result = originalAppend.apply(this, arguments);
        if ($(this).closest('#chatMessages').length > 0) {
            setTimeout(() => {
                fixChatProductIcons();
                if (typeof updateCartUI === 'function') {
                    updateCartUI();
                }
            }, 100);
        }
        return result;
    };
});

// Message handling
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendCurrentMessage();
    }
}

function sendCurrentMessage() {
    const message = $('#messageInput').val().trim();
    if (message || currentImageData) {
        sendMessage(message, currentImageData);
        $('#messageInput').val('');
        clearImage();
    }
}

function sendMessage(message, imageData = null) {
    if (!message.trim() && !imageData) return;
    
    // Add user message to chat
    addMessageToChat('user', message, imageData);
    
    // Hide welcome message
    $('.welcome-message').hide();
    
    // Show loading
    console.log('Showing loading modal...');
    $('#loadingModal').modal('show');
    
    // Send to API
    $.ajax({
        url: '/api/agent/chat',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            message: message,
            session_id: sessionId,
            image: imageData
        }),
        success: function(response) {
            console.log('Response received:', response);
            console.log('Attempting to hide modal...');
            
            // Hide loading modal
            $('#loadingModal').modal('hide');
            
            console.log('Modal should be hidden now');
            
            if (response.success) {
                // Add assistant response
                addMessageToChat('assistant', response.response, null, response.products);
                
                // Update suggestions
                updateSuggestions(response.suggestions || []);
                
                // Track products shown
                if (response.products && response.products.length > 0) {
                    updateRecentProducts(response.products);
                }
            } else {
                addMessageToChat('assistant', response.response || 'Sorry, I encountered an error.');
            }
        },
        error: function(xhr, status, error) {
            console.log('Error occurred, hiding modal...');
            $('#loadingModal').modal('hide');
            
            let errorMsg = 'Sorry, I\'m having trouble connecting. Please try again.';
            
            // Try to get specific error message from response
            if (xhr.responseJSON) {
                if (xhr.responseJSON.error) {
                    errorMsg = `Error: ${xhr.responseJSON.error}`;
                } else if (xhr.responseJSON.response) {
                    errorMsg = xhr.responseJSON.response;
                }
            }
            
            addMessageToChat('assistant', errorMsg);
        }
    });
}

function addMessageToChat(role, content, imageData = null, products = null) {
    const chatMessages = $('#chatMessages');
    const timestamp = new Date().toLocaleTimeString();
    messageCount++;
    
    let messageHtml = '';
    
    if (role === 'user') {
        messageHtml = `
            <div class="message user-message mb-3">
                <div class="d-flex justify-content-end">
                    <div class="message-content bg-primary text-white rounded p-2" style="max-width: 70%;">
                        ${imageData ? `<img src="data:image/jpeg;base64,${imageData}" class="img-fluid rounded mb-2" style="max-height: 200px;">` : ''}
                        <div>${content}</div>
                        <small class="opacity-75">${timestamp}</small>
                    </div>
                </div>
            </div>
        `;
    } else {
        messageHtml = `
            <div class="message assistant-message mb-3">
                <div class="d-flex">
                    <div class="me-2">
                        <div class="avatar bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                            <i class="bi bi-robot text-white"></i>
                        </div>
                    </div>
                    <div class="message-content bg-light rounded p-2" style="max-width: 70%;">
                        <div>${formatMessage(content)}</div>
                        ${products ? formatProducts(products) : ''}
                        <small class="text-muted">${timestamp}</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    chatMessages.append(messageHtml);
    chatMessages.scrollTop(chatMessages[0].scrollHeight);
}

function formatMessage(content) {
    // Convert markdown-like formatting to HTML
    return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
}

function formatProducts(products) {
    if (!products || products.length === 0) return '';
    
    let html = '<div class="products-container mt-3">';
    html += '<h6 class="mb-2">Products Found:</h6>';
    html += '<div class="row g-2">';
    
    products.slice(0, 4).forEach((product, index) => {
        const imageUrl = product.images && product.images.length > 0 ? product.images[0].url : '/static/images/placeholder.svg';
        const price = product.price ? `$${parseFloat(product.price).toFixed(2)}` : 'Price N/A';
        const cartItem = cartManager ? cartManager.getCartItem(product.id) : null;
        
        html += `
            <div class="col-6">
                <div class="card product-card h-100" data-product-id="${product.id}" onclick="viewProduct(${product.id})" style="cursor: pointer;">
                    <img src="${imageUrl}" class="card-img-top product-image" style="height: 120px; object-fit: cover;">
                    <div class="card-body p-2">
                        <h6 class="card-title product-title small mb-1">${product.title}</h6>
                        <p class="card-text mb-0">
                            <span class="current-price text-primary fw-bold">${price}</span>
                        </p>
                        <small class="product-vendor text-muted">${product.vendor || ''}</small>
                        <div class="product-actions mt-2">`;
        
        if (cartItem) {
            html += `
                            <div style="display: flex; gap: 8px; width: 100%;">
                                <div class="cart-controls" style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <button class="quantity-btn" onclick="event.stopPropagation(); decreaseQuantity(${product.id})" onmouseover="this.style.background='#f5f5f5'; this.style.borderColor='#007bff'; this.style.color='#007bff';" onmouseout="this.style.background='white'; this.style.borderColor='#ddd'; this.style.color='#666';" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 16px; font-weight: bold; color: #666; padding: 0; line-height: 1;">
                                        ‚àí
                                    </button>
                                    <span class="quantity-display" style="min-width: 40px; text-align: center; font-size: 16px; font-weight: 600; color: #333;">${cartItem.quantity}</span>
                                    <button class="quantity-btn" onclick="event.stopPropagation(); increaseQuantity(${product.id})" onmouseover="this.style.background='#f5f5f5'; this.style.borderColor='#007bff'; this.style.color='#007bff';" onmouseout="this.style.background='white'; this.style.borderColor='#ddd'; this.style.color='#666';" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 16px; font-weight: bold; color: #666; padding: 0; line-height: 1;">
                                        +
                                    </button>
                                    <button class="remove-btn" onclick="event.stopPropagation(); removeFromCart(${product.id})" onmouseover="this.style.background='#c82333';" onmouseout="this.style.background='#dc3545';" title="Remove from cart" style="width: 32px; height: 32px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; padding: 0; line-height: 1; margin-left: 4px;">
                                        <svg width="14" height="14" viewBox="0 0 14 14" fill="white" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M4.5 5.5V10.5M7 5.5V10.5M9.5 5.5V10.5M2 3.5H12M10.5 3.5V11.5C10.5 12.0523 10.0523 12.5 9.5 12.5H4.5C3.94772 12.5 3.5 12.0523 3.5 11.5V3.5M8.5 3.5V2.5C8.5 1.94772 8.05228 1.5 7.5 1.5H6.5C5.94772 1.5 5.5 1.94772 5.5 2.5V3.5" stroke="white" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                                <button class="quick-view-btn" onclick="event.stopPropagation(); quickView(${product.id})" onmouseover="this.style.background='#e9ecef'; this.style.borderColor='#007bff';" onmouseout="this.style.background='#f8f9fa'; this.style.borderColor='#e5e5e5';" style="width: 40px; height: 40px; background: #f8f9fa; border: 1px solid #e5e5e5; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-size: 16px; padding: 0; line-height: 1;">
                                    <span>üëÅÔ∏è</span>
                                </button>
                            </div>`;
        } else {
            html += `
                            <div style="display: flex; gap: 8px; width: 100%;">
                                <button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCart(${product.id})" onmouseover="this.style.background='#218838';" onmouseout="this.style.background='#28a745';" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; transition: background-color 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                    Add to Cart
                                </button>
                                <button class="quick-view-btn" onclick="event.stopPropagation(); quickView(${product.id})" onmouseover="this.style.background='#e9ecef'; this.style.borderColor='#007bff';" onmouseout="this.style.background='#f8f9fa'; this.style.borderColor='#e5e5e5';" style="width: 40px; height: 40px; background: #f8f9fa; border: 1px solid #e5e5e5; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-size: 16px; padding: 0; line-height: 1;">
                                    <span>üëÅÔ∏è</span>
                                </button>
                            </div>`;
        }
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    if (products.length > 4) {
        html += `<p class="text-muted small mt-2">And ${products.length - 4} more products...</p>`;
    }
    
    html += '</div>';
    
    // Update cart UI after rendering products
    setTimeout(() => {
        if (typeof updateCartUI === 'function') {
            updateCartUI();
        }
        // Fix icons in chat products
        fixChatProductIcons();
    }, 100);
    
    return html;
}

// Image handling
function toggleImageUpload() {
    const container = $('#imageUploadContainer');
    container.toggle();
}

function handleImageSelect(event) {
    const file = event.target.files[0];
    if (file) {
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
            alert('File size too large. Please select an image under 10MB.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            currentImageData = e.target.result.split(',')[1]; // Remove data:image/jpeg;base64, prefix
            showImagePreview(e.target.result);
        };
        reader.readAsDataURL(file);
    }
}

function showImagePreview(dataUrl) {
    $('#imagePreview').attr('src', dataUrl);
    $('#imageUploadText').hide();
    $('#imagePreviewContainer').show();
}

function clearImage() {
    currentImageData = null;
    $('#imageInput').val('');
    $('#imagePreview').attr('src', '');
    $('#imageUploadText').show();
    $('#imagePreviewContainer').hide();
    $('#imageUploadContainer').hide();
}

function setupDragAndDrop() {
    const uploadArea = $('.image-upload-area');
    
    uploadArea.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('drag-over');
    });
    
    uploadArea.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('drag-over');
    });
    
    uploadArea.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('drag-over');
        
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                $('#imageInput')[0].files = files;
                handleImageSelect({target: {files: files}});
            }
        }
    });
}

// Suggestions
function updateSuggestions(suggestions) {
    if (suggestions.length === 0) {
        $('#suggestions').hide();
        return;
    }
    
    const container = $('#suggestionButtons');
    container.empty();
    
    suggestions.forEach(suggestion => {
        container.append(`
            <button class="btn btn-outline-primary btn-sm suggestion-btn" onclick="sendMessage('${suggestion}')">
                ${suggestion}
            </button>
        `);
    });
    
    $('#suggestions').show();
}

// Recent products
function updateRecentProducts(products) {
    const container = $('#recentProducts');
    container.empty();
    
    products.slice(0, 3).forEach(product => {
        const imageUrl = product.images && product.images.length > 0 ? product.images[0].url : '/static/images/placeholder.svg';
        const price = product.price ? `$${parseFloat(product.price).toFixed(2)}` : 'N/A';
        
        container.append(`
            <div class="d-flex mb-2 product-item" onclick="showProductDetails(${product.id})" style="cursor: pointer;">
                <img src="${imageUrl}" class="rounded me-2" style="width: 50px; height: 50px; object-fit: cover;">
                <div class="flex-grow-1">
                    <div class="fw-bold small">${product.title}</div>
                    <div class="text-primary small">${price}</div>
                </div>
            </div>
        `);
    });
}

// Product details
function viewProduct(productId) {
    // Show modal first
    $('#productModal').modal('show');
    
    // Show loading state in the entire modal body
    const loadingHtml = `
        <div class="container-fluid">
            <div class="row">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading product details...</p>
                </div>
            </div>
        </div>
    `;
    
    $('#productModalBody').html(loadingHtml);
    
    // Fetch product details
    $.ajax({
        url: `/api/products/${productId}`,
        method: 'GET',
        success: function(product) {
            console.log('Product loaded:', product);
            displayProductInModal(product);
        },
        error: function(xhr, status, error) {
            console.error('Error loading product:', error);
            $('#productModalBody').html(`
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-exclamation-circle text-danger" style="font-size: 3rem;"></i>
                            <p class="mt-3">Failed to load product details</p>
                            <p class="text-muted">${error || 'Please try again'}</p>
                        </div>
                    </div>
                </div>
            `);
        }
    });
}

function displayProductInModal(product) {
    // Build the complete modal content
    const mainImage = product.images && product.images.length > 0 ? product.images[0].url : '/static/images/placeholder.svg';
    
    // Create thumbnails HTML
    let thumbnailsHtml = '';
    if (product.images && product.images.length > 0) {
        product.images.forEach((img, index) => {
            thumbnailsHtml += `
                <div class="thumbnail ${index === 0 ? 'active' : ''}" style="width: 60px; height: 60px; cursor: pointer; border: 2px solid ${index === 0 ? '#007bff' : 'transparent'}; border-radius: 4px; overflow: hidden;" onclick="changeMainImage('${img.url}', this)">
                    <img src="${img.url}" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            `;
        });
    }
    
    // Build options HTML
    let optionsHtml = '';
    if (product.variants && product.variants.length > 1) {
        const uniqueOptions = new Set();
        product.variants.forEach(v => {
            if (v.option1) uniqueOptions.add(v.option1);
        });
        
        if (uniqueOptions.size > 0) {
            optionsHtml = '<div class="mb-3"><label class="form-label">Options:</label><div class="d-flex gap-2 flex-wrap">';
            uniqueOptions.forEach(option => {
                optionsHtml += `<button class="btn btn-outline-secondary btn-sm">${option}</button>`;
            });
            optionsHtml += '</div></div>';
        }
    }
    
    // Build cart actions HTML
    const cartItem = cartManager ? cartManager.getCartItem(product.id) : null;
    let cartActionsHtml = '';
    
    if (cartItem) {
        cartActionsHtml = `
            <div class="d-flex align-items-center gap-2">
                <div class="cart-controls" style="display: flex; align-items: center; gap: 8px; flex: 1;">
                    <button class="quantity-btn" onclick="decreaseQuantity(${product.id}); setTimeout(() => updateModalCartActions(${product.id}), 100);" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 12px; color: #666;">
                        <i class="fas fa-minus" style="font-family: 'Font Awesome 6 Free'; font-weight: 900;"></i>
                    </button>
                    <span class="quantity-display" style="min-width: 40px; text-align: center; font-size: 16px; font-weight: 600; color: #333;">${cartItem.quantity}</span>
                    <button class="quantity-btn" onclick="increaseQuantity(${product.id}); setTimeout(() => updateModalCartActions(${product.id}), 100);" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 12px; color: #666;">
                        <i class="fas fa-plus" style="font-family: 'Font Awesome 6 Free'; font-weight: 900;"></i>
                    </button>
                </div>
                <button class="remove-btn" onclick="removeFromCart(${product.id}); setTimeout(() => updateModalCartActions(${product.id}), 100);" style="width: auto; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 14px; gap: 6px;">
                    <i class="fas fa-trash" style="font-family: 'Font Awesome 6 Free'; font-weight: 900;"></i> Remove from Cart
                </button>
            </div>
        `;
    } else {
        cartActionsHtml = `
            <button class="add-to-cart-btn btn-lg" onclick="addToCartFromModal(${product.id}); setTimeout(() => updateModalCartActions(${product.id}), 100);" style="flex: 1; padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 16px; transition: background-color 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="fas fa-shopping-cart" style="font-family: 'Font Awesome 6 Free'; font-weight: 900;"></i> Add to Cart
            </button>
        `;
    }
    
    // Build additional details HTML
    let detailsHtml = '';
    if (product.sku) detailsHtml += `<li><strong>SKU:</strong> ${product.sku}</li>`;
    if (product.product_type) detailsHtml += `<li><strong>Type:</strong> ${product.product_type}</li>`;
    if (product.tags) detailsHtml += `<li><strong>Tags:</strong> ${product.tags}</li>`;
    
    // Build the complete modal body HTML
    const modalBodyHtml = `
        <div class="container-fluid">
            <div class="row">
                <!-- Image Gallery -->
                <div class="col-lg-6 p-4">
                    <div class="product-image-gallery">
                        <div class="main-product-image mb-3" style="height: 400px; overflow: hidden; border-radius: 8px;">
                            <img id="mainProductImage" src="${mainImage}" alt="${product.title}" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="product-thumbnails d-flex gap-2 flex-wrap" id="productThumbnails">
                            ${thumbnailsHtml}
                        </div>
                    </div>
                </div>
                
                <!-- Product Info -->
                <div class="col-lg-6 p-4">
                    <div class="product-details">
                        <h2 id="modalProductTitle" class="mb-3">${product.title}</h2>
                        <p class="text-muted mb-3" id="modalProductVendor">${product.vendor || 'Unknown Brand'}</p>
                        
                        <div class="price-section mb-4">
                            <h3 class="text-primary" id="modalProductPrice">$${parseFloat(product.price || 0).toFixed(2)}</h3>
                        </div>
                        
                        <!-- Options -->
                        <div id="modalProductOptions" class="mb-4">
                            ${optionsHtml}
                        </div>
                        
                        <!-- Cart Actions -->
                        <div class="cart-actions mb-4" id="modalCartActions">
                            ${cartActionsHtml}
                        </div>
                        
                        <!-- Description -->
                        <div class="product-description">
                            <h5>Description</h5>
                            <div id="modalProductDescription">${product.description || '<p class="text-muted">No description available</p>'}</div>
                        </div>
                        
                        <!-- Additional Details -->
                        <div class="additional-details mt-4">
                            <h6>Product Details</h6>
                            <ul class="list-unstyled" id="modalProductDetails">
                                ${detailsHtml || '<li class="text-muted">No additional details available</li>'}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Update the modal body with the complete HTML
    $('#productModalBody').html(modalBodyHtml);
    
    // Apply hover effects after initial render
    setTimeout(() => {
        $('#modalCartActions .quantity-btn').hover(
            function() { $(this).css({'background': '#f5f5f5', 'border-color': '#007bff', 'color': '#007bff'}); },
            function() { $(this).css({'background': 'white', 'border-color': '#ddd', 'color': '#666'}); }
        );
        $('#modalCartActions .remove-btn').hover(
            function() { $(this).css('background', '#c82333'); },
            function() { $(this).css('background', '#dc3545'); }
        );
        $('#modalCartActions .add-to-cart-btn').hover(
            function() { $(this).css('background', '#218838'); },
            function() { $(this).css('background', '#28a745'); }
        );
        
        // Fix icons after initial load
        fixModalIcons();
    }, 100);
}

function changeMainImage(imageUrl, thumbnailElement) {
    $('#mainProductImage').attr('src', imageUrl);
    $('.thumbnail').css('border-color', 'transparent');
    $(thumbnailElement).css('border-color', '#007bff');
}

function addToCartFromModal(productId) {
    // Get product data from modal
    const productData = {
        id: productId,
        title: $('#modalProductTitle').text(),
        price: $('#modalProductPrice').text().replace('$', ''),
        vendor: $('#modalProductVendor').text(),
        image: $('#mainProductImage').attr('src')
    };
    
    cartManager.addToCart(productId, productData);
    updateCartUI();
}

function updateModalCartActions(productId) {
    // Re-fetch product to update cart actions
    $.ajax({
        url: `/api/products/${productId}`,
        method: 'GET',
        success: function(product) {
            const cartItem = cartManager ? cartManager.getCartItem(product.id) : null;
            let cartActionsHtml = '';
            
            if (cartItem) {
                cartActionsHtml = `
                    <div class="d-flex align-items-center gap-2">
                        <div class="cart-controls" style="display: flex; align-items: center; gap: 8px; flex: 1;">
                            <button class="quantity-btn" onclick="decreaseQuantity(${product.id}); setTimeout(() => updateModalCartActions(${product.id}), 100);" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 12px; color: #666;">
                                <i class="fas fa-minus" style="font-family: 'Font Awesome 6 Free'; font-weight: 900;"></i>
                            </button>
                            <span class="quantity-display" style="min-width: 40px; text-align: center; font-size: 16px; font-weight: 600; color: #333;">${cartItem.quantity}</span>
                            <button class="quantity-btn" onclick="increaseQuantity(${product.id}); setTimeout(() => updateModalCartActions(${product.id}), 100);" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 12px; color: #666;">
                                <i class="fas fa-plus" style="font-family: 'Font Awesome 6 Free'; font-weight: 900;"></i>
                            </button>
                        </div>
                        <button class="remove-btn" onclick="removeFromCart(${product.id}); setTimeout(() => updateModalCartActions(${product.id}), 100);" style="width: auto; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 14px; gap: 6px;">
                            <i class="fas fa-trash" style="font-family: 'Font Awesome 6 Free'; font-weight: 900;"></i> Remove from Cart
                        </button>
                    </div>
                `;
            } else {
                cartActionsHtml = `
                    <button class="add-to-cart-btn btn-lg" onclick="addToCartFromModal(${product.id}); setTimeout(() => updateModalCartActions(${product.id}), 100);" style="flex: 1; padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 16px; transition: background-color 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-shopping-cart" style="font-family: 'Font Awesome 6 Free'; font-weight: 900;"></i> Add to Cart
                    </button>
                `;
            }
            
            $('#modalCartActions').html(cartActionsHtml);
            
            // Fix Font Awesome icons
            setTimeout(fixModalIcons, 10);
            
            // Re-apply hover effects after DOM update
            $('#modalCartActions .quantity-btn').hover(
                function() { $(this).css({'background': '#f5f5f5', 'border-color': '#007bff', 'color': '#007bff'}); },
                function() { $(this).css({'background': 'white', 'border-color': '#ddd', 'color': '#666'}); }
            );
            $('#modalCartActions .remove-btn').hover(
                function() { $(this).css('background', '#c82333'); },
                function() { $(this).css('background', '#dc3545'); }
            );
            $('#modalCartActions .add-to-cart-btn').hover(
                function() { $(this).css('background', '#218838'); },
                function() { $(this).css('background', '#28a745'); }
            );
        }
    });
}

function changeMainImage(imageUrl, thumbnailElement) {
    $('#mainProductImage').attr('src', imageUrl);
    $('.thumbnail').css('border-color', 'transparent');
    $(thumbnailElement).css('border-color', '#007bff');
}

function addToCartFromModal(productId) {
    // Get product data from modal
    const productData = {
        id: productId,
        title: $('#modalProductTitle').text(),
        price: $('#modalProductPrice').text().replace('$', ''),
        vendor: $('#modalProductVendor').text(),
        image: $('#mainProductImage').attr('src')
    };
    
    cartManager.addToCart(productId, productData);
    updateCartUI();
}

function updateModalCartActions(productId) {
    // Re-fetch product to update cart actions
    $.ajax({
        url: `/api/products/${productId}`,
        method: 'GET',
        success: function(product) {
            const cartItem = cartManager ? cartManager.getCartItem(product.id) : null;
            let cartActionsHtml = '';
            
            if (cartItem) {
                cartActionsHtml = `
                    <div class="d-flex align-items-center gap-2">
                        <div class="cart-controls" style="display: flex; align-items: center; gap: 8px; flex: 1;">
                            <button class="quantity-btn" onclick="decreaseQuantity(${product.id}); setTimeout(() => updateModalCartActions(${product.id}), 100);" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 12px; color: #666;">
                                <i class="fas fa-minus" style="font-family: 'Font Awesome 6 Free'; font-weight: 900;"></i>
                            </button>
                            <span class="quantity-display" style="min-width: 40px; text-align: center; font-size: 16px; font-weight: 600; color: #333;">${cartItem.quantity}</span>
                            <button class="quantity-btn" onclick="increaseQuantity(${product.id}); setTimeout(() => updateModalCartActions(${product.id}), 100);" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 12px; color: #666;">
                                <i class="fas fa-plus" style="font-family: 'Font Awesome 6 Free'; font-weight: 900;"></i>
                            </button>
                        </div>
                        <button class="remove-btn" onclick="removeFromCart(${product.id}); setTimeout(() => updateModalCartActions(${product.id}), 100);" style="width: auto; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 14px; gap: 6px;">
                            <i class="fas fa-trash" style="font-family: 'Font Awesome 6 Free'; font-weight: 900;"></i> Remove from Cart
                        </button>
                    </div>
                `;
            } else {
                cartActionsHtml = `
                    <button class="add-to-cart-btn btn-lg" onclick="addToCartFromModal(${product.id}); setTimeout(() => updateModalCartActions(${product.id}), 100);" style="flex: 1; padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 16px; transition: background-color 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-shopping-cart" style="font-family: 'Font Awesome 6 Free'; font-weight: 900;"></i> Add to Cart
                    </button>
                `;
            }
            
            $('#modalCartActions').html(cartActionsHtml);
            
            // Fix Font Awesome icons
            setTimeout(fixModalIcons, 10);
            
            // Re-apply hover effects after DOM update
            $('#modalCartActions .quantity-btn').hover(
                function() { $(this).css({'background': '#f5f5f5', 'border-color': '#007bff', 'color': '#007bff'}); },
                function() { $(this).css({'background': 'white', 'border-color': '#ddd', 'color': '#666'}); }
            );
            $('#modalCartActions .remove-btn').hover(
                function() { $(this).css('background', '#c82333'); },
                function() { $(this).css('background', '#dc3545'); }
            );
            $('#modalCartActions .add-to-cart-btn').hover(
                function() { $(this).css('background', '#218838'); },
                function() { $(this).css('background', '#28a745'); }
            );
        }
    });
}

function showProductDetails(productId) {
    // Fetch and show product details in modal
    $.get(`/api/skus/${productId}`)
        .done(function(product) {
            $('#productModalTitle').text(product.title);
            
            const imageUrl = product.images && product.images.length > 0 ? product.images[0].url : '/static/images/placeholder.svg';
            const price = product.price ? `$${parseFloat(product.price).toFixed(2)}` : 'Price N/A';
            const stock = product.quantity > 0 ? `${product.quantity} in stock` : 'Out of stock';
            
            $('#productModalBody').html(`
                <div class="row">
                    <div class="col-md-6">
                        <img src="${imageUrl}" class="img-fluid rounded">
                    </div>
                    <div class="col-md-6">
                        <h4>${product.title}</h4>
                        <p class="text-primary fs-4 fw-bold">${price}</p>
                        <p><strong>Vendor:</strong> ${product.vendor || 'N/A'}</p>
                        <p><strong>Stock:</strong> ${stock}</p>
                        <p><strong>Description:</strong></p>
                        <p>${product.description || 'No description available'}</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="askAboutProduct(${productId})">Ask about this product</button>
                            <button class="btn btn-outline-primary" onclick="findSimilar(${productId})">Find similar products</button>
                        </div>
                    </div>
                </div>
            `);
            
            $('#productModal').modal('show');
        })
        .fail(function() {
            alert('Failed to load product details');
        });
}

function askAboutProduct(productId) {
    $('#productModal').modal('hide');
    sendMessage(`Tell me more about product ID ${productId}`);
}

function findSimilar(productId) {
    $('#productModal').modal('hide');
    sendMessage(`Show me products similar to product ID ${productId}`);
}

// Chat management
function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        $.ajax({
            url: `/api/agent/history/${sessionId}`,
            method: 'DELETE',
            success: function() {
                $('#chatMessages').empty();
                $('.welcome-message').show();
                $('#recentProducts').html('<p class="text-muted text-center">Products you\'ve viewed will appear here</p>');
                $('#suggestions').hide();
                messageCount = 0;
            }
        });
    }
}

function exportChat() {
    $.get(`/api/agent/history/${sessionId}`)
        .done(function(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_history_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        });
}

function loadConversationHistory() {
    $.get(`/api/agent/history/${sessionId}`)
        .done(function(data) {
            if (data.messages && data.messages.length > 0) {
                $('.welcome-message').hide();
                data.messages.forEach(msg => {
                    if (msg.role !== 'system') {
                        addMessageToChat(msg.role, msg.content);
                    }
                });
            }
        });
}

function quickView(productId) {
    // For now, just trigger the same modal as viewProduct
    viewProduct(productId);
}

// Function to fix Font Awesome icons in modal
function fixModalIcons() {
    try {
        // Replace minus icon
        $('#modalCartActions .fa-minus').each(function() {
            if ($(this).text() === '' && $(this).html() === '') {
                $(this).replaceWith('‚àí');
            }
        });
        
        // Replace plus icon  
        $('#modalCartActions .fa-plus').each(function() {
            if ($(this).text() === '' && $(this).html() === '') {
                $(this).replaceWith('+');
            }
        });
    } catch (e) {
        console.error('Error fixing modal icons:', e);
    }
}

// Function to fix Font Awesome icons in chat products
function fixChatProductIcons() {
    // No longer needed since we're using text/emoji directly
    return;
}

// Function to update chat product cards when cart state changes
function updateChatProductCards() {
    const productCards = document.querySelectorAll('.products-container .product-card');
    
    productCards.forEach(card => {
        const productId = parseInt(card.dataset.productId);
        const cartItem = cartManager ? cartManager.getCartItem(productId) : null;
        const actionsDiv = card.querySelector('.product-actions');
        
        if (cartItem && actionsDiv) {
            // Replace add to cart button with quantity controls
            actionsDiv.innerHTML = `
                <div style="display: flex; gap: 8px; width: 100%;">
                    <div class="cart-controls" style="display: flex; align-items: center; gap: 8px; flex: 1;">
                        <button class="quantity-btn" onclick="event.stopPropagation(); decreaseQuantity(${productId})" onmouseover="this.style.background='#f5f5f5'; this.style.borderColor='#007bff'; this.style.color='#007bff';" onmouseout="this.style.background='white'; this.style.borderColor='#ddd'; this.style.color='#666';" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 16px; font-weight: bold; color: #666; padding: 0; line-height: 1;">
                            ‚àí
                        </button>
                        <span class="quantity-display" style="min-width: 40px; text-align: center; font-size: 16px; font-weight: 600; color: #333;">${cartItem.quantity}</span>
                        <button class="quantity-btn" onclick="event.stopPropagation(); increaseQuantity(${productId})" onmouseover="this.style.background='#f5f5f5'; this.style.borderColor='#007bff'; this.style.color='#007bff';" onmouseout="this.style.background='white'; this.style.borderColor='#ddd'; this.style.color='#666';" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 16px; font-weight: bold; color: #666; padding: 0; line-height: 1;">
                            +
                        </button>
                        <button class="remove-btn" onclick="event.stopPropagation(); removeFromCart(${productId})" onmouseover="this.style.background='#c82333';" onmouseout="this.style.background='#dc3545';" title="Remove from cart" style="width: 32px; height: 32px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; padding: 0; line-height: 1; margin-left: 4px;">
                            <svg width="14" height="14" viewBox="0 0 14 14" fill="white" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4.5 5.5V10.5M7 5.5V10.5M9.5 5.5V10.5M2 3.5H12M10.5 3.5V11.5C10.5 12.0523 10.0523 12.5 9.5 12.5H4.5C3.94772 12.5 3.5 12.0523 3.5 11.5V3.5M8.5 3.5V2.5C8.5 1.94772 8.05228 1.5 7.5 1.5H6.5C5.94772 1.5 5.5 1.94772 5.5 2.5V3.5" stroke="white" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                    <button class="quick-view-btn" onclick="event.stopPropagation(); quickView(${productId})" onmouseover="this.style.background='#e9ecef'; this.style.borderColor='#007bff';" onmouseout="this.style.background='#f8f9fa'; this.style.borderColor='#e5e5e5';" style="width: 40px; height: 40px; background: #f8f9fa; border: 1px solid #e5e5e5; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-size: 16px; padding: 0; line-height: 1;">
                        <span>üëÅÔ∏è</span>
                    </button>
                </div>
            `;
        } else if (!cartItem && actionsDiv) {
            // Restore add to cart button if item was removed
            actionsDiv.innerHTML = `
                <div style="display: flex; gap: 8px; width: 100%;">
                    <button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCart(${productId})" onmouseover="this.style.background='#218838';" onmouseout="this.style.background='#28a745';" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; transition: background-color 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        Add to Cart
                    </button>
                    <button class="quick-view-btn" onclick="event.stopPropagation(); quickView(${productId})" onmouseover="this.style.background='#e9ecef'; this.style.borderColor='#007bff';" onmouseout="this.style.background='#f8f9fa'; this.style.borderColor='#e5e5e5';" style="width: 40px; height: 40px; background: #f8f9fa; border: 1px solid #e5e5e5; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-size: 16px; padding: 0; line-height: 1;">
                        <span>üëÅÔ∏è</span>
                    </button>
                </div>
            `;
        }
    });
}

// Ensure cart UI is updated when cart.js loads
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for cart.js to initialize
    setTimeout(() => {
        if (typeof updateCartUI === 'function') {
            updateCartUI();
        }
    }, 100);
    
    // Simple icon fix approach
    setTimeout(() => {
        // Just fix icons once after page load
        fixChatProductIcons();
        fixModalIcons();
        
        // Override updateCartUI after cart.js loads
        if (typeof window.updateCartUI === 'function') {
            const originalUpdateCartUI = window.updateCartUI;
            window.updateCartUI = function() {
                originalUpdateCartUI.apply(this, arguments);
                // Update chat products with our custom styling
                updateChatProductCards();
            };
        }
    }, 500);
});
</script>
<script src="{{ url_for('static', filename='js/cart.js') }}"></script>
{% endblock %}